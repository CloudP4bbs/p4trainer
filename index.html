<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P4Trainer - Login</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container login-container">
        <header>
            <h1>P4Trainer</h1>
        </header>
        <main>
            <form id="loginForm">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="email">Email (ou "admin" para teste inicial):</label>
                    <input type="text" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha (ou "p4trainer" para teste inicial):</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
                <p id="loginError" class="error-message"></p>
            </form>
        </main>
        <footer>
            <p>&copy; 2025 P4Trainer</p>
        </footer>
    </div>

    <script type="module">
        // Importe as funções que você precisa das SDKs que você precisa
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        // Adicione as SDKs para os produtos Firebase que você deseja usar
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBwLLJDdIEX7R82RxGTbfAWU3olGBaGfn8", // Sua API Key
            authDomain: "p4trainer-268bf.firebaseapp.com",
            projectId: "p4trainer-268bf",
            storageBucket: "p4trainer-268bf.firebasestorage.app",
            messagingSenderId: "249928558281",
            appId: "1:249928558281:web:0de427b8ce07cb0f0d8f18",
            measurementId: "G-CE01C7Z0LB"
        };

        // Inicialize o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Lógica de Login
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // Checa estado de autenticação
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Usuário logado:", user.uid, user.email);
                // Verificar papel do usuário no Firestore
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        console.log("Dados do usuário:", userData);
                        if (userData.role === 'admin') {
                            window.location.href = 'admin.html';
                        } else if (userData.role === 'aluno') {
                            window.location.href = 'student.html';
                        } else {
                            loginError.textContent = "Papel de usuário não definido. Contate o suporte.";
                            await signOut(auth); // Faz logout se o papel não for reconhecido
                        }
                    } else {
                        // Este caso pode ocorrer se o usuário admin inicial (admin@p4trainer.com)
                        // foi autenticado, mas o documento 'role' não foi criado no Firestore.
                        if (user.email === 'admin@p4trainer.com') { // Email usado para o admin no Firebase Auth
                            console.warn("Admin logado, mas sem documento de 'role' no Firestore. Redirecionando para admin.html. CRIE O DOCUMENTO NO FIRESTORE!");
                            window.location.href = 'admin.html';
                        } else {
                            loginError.textContent = "Usuário não encontrado no banco de dados de papéis.";
                            await signOut(auth);
                        }
                    }
                } catch (error) {
                    console.error("Erro ao buscar papel do usuário:", error);
                    loginError.textContent = "Erro ao verificar dados do usuário. Tente novamente.";
                    await signOut(auth);
                }
            } else {
                console.log("Nenhum usuário logado.");
                // Permanece na página de login ou limpa erros se necessário
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailInput = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';

            // Lógica para o admin inicial (admin/p4trainer)
            // EM PRODUÇÃO: Crie um usuário admin real no Firebase Auth (ex: admin@seudominio.com)
            // e associe a role "admin" a ele no Firestore.
            if (emailInput.toLowerCase() === 'admin' && password === 'p4trainer') {
                console.log("Tentativa de login com credenciais de admin hardcoded (admin/p4trainer).");
                // Tenta logar com um email de admin pré-definido no Firebase Auth
                // Certifique-se de que este usuário 'admin@p4trainer.com' exista no Firebase Authentication
                // e tenha a senha 'p4trainer'.
                try {
                    // ************************************************************************************
                    // IMPORTANTE: Substitua 'admin@p4trainer.com' pelo email real do seu admin
                    // cadastrado no Firebase Authentication. A senha deve corresponder.
                    // ************************************************************************************
                    const userCredential = await signInWithEmailAndPassword(auth, "admin@p4trainer.com", "p4trainer");
                    // O onAuthStateChanged tratará do redirecionamento.
                    console.log("Login do admin (admin@p4trainer.com) bem-sucedido via Firebase Auth.");
                } catch (error) {
                    console.error("Erro no login do admin (admin@p4trainer.com) com Firebase:", error);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        loginError.textContent = 'Credenciais de admin (admin@p4trainer.com) inválidas no Firebase. Verifique o console do Firebase.';
                    } else if (error.code === 'auth/invalid-email') {
                         loginError.textContent = 'O email "admin@p4trainer.com" é inválido. Verifique a configuração.';
                    }
                    else {
                        loginError.textContent = 'Erro ao logar admin: ' + error.message;
                    }
                }
                return; // Finaliza aqui para o admin
            }

            // Lógica de login para alunos (usando Firebase Auth com o email fornecido)
            try {
                const userCredential = await signInWithEmailAndPassword(auth, emailInput, password);
                // O onAuthStateChanged tratará do redirecionamento.
                console.log("Login de aluno bem-sucedido:", userCredential.user.email);
            } catch (error) {
                console.error("Erro de login do aluno:", error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    loginError.textContent = 'Email ou senha inválidos.';
                } else if (error.code === 'auth/invalid-email') {
                    loginError.textContent = 'Formato de email inválido.';
                }
                else {
                    loginError.textContent = 'Erro ao fazer login: ' + error.message;
                }
            }
        });
    </script>
</body>
</html>

