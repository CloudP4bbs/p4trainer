<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P4Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .navbar h2 {
            color: white;
            font-size: 1.2rem;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .workout-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .workout-day {
            font-weight: bold;
            font-size: 1.1rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .exercise-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .exercise-image {
            width: 60px;
            height: 107px;
            border-radius: 8px;
            object-fit: cover;
            background: #e9ecef;
        }

        .exercise-details {
            flex: 1;
        }

        .exercise-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .exercise-reps {
            color: #666;
            font-size: 0.9rem;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .day-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-btn {
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .day-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
            object-fit: cover;
        }

        .user-selector {
            margin-bottom: 20px;
        }

        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .student-card:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .student-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .student-workouts {
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela de Login -->
        <div id="loginScreen" class="screen">
            <div class="header">
                <h1>üí™ P4Trainer</h1>
                <p>Sistema de Treinos Personalizado</p>
            </div>
            
            <div class="card">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Usu√°rio</label>
                        <input type="text" id="username" class="form-control" placeholder="Digite seu usu√°rio" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" class="form-control" placeholder="Digite sua senha" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
            </div>
        </div>

        <!-- Tela do Admin -->
        <div id="adminScreen" class="screen hidden">
            <div class="navbar">
                <h2>üë®‚Äçüíº Painel Admin</h2>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>

            <div class="card">
                <button class="btn btn-primary" onclick="showCreateWorkout()">+ Criar Novo Treino</button>
                <button class="btn btn-secondary" onclick="showStudentManagement()">üë• Gerenciar Alunos</button>
            </div>

            <div id="workoutsList"></div>
        </div>

        <!-- Tela do Aluno -->
        <div id="studentScreen" class="screen hidden">
            <div class="navbar">
                <h2 id="studentWelcome">üëã Ol√°, Aluno!</h2>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>

            <div id="studentWorkouts"></div>
        </div>

        <!-- Tela de Sele√ß√£o de Aluno (Admin) -->
        <div id="studentSelectionScreen" class="screen hidden">
            <div class="navbar">
                <h2>üë• Selecionar Aluno</h2>
                <button class="btn-logout" onclick="showAdminScreen()">Voltar</button>
            </div>

            <div class="card">
                <div class="form-group">
                    <label>Novo Aluno</label>
                    <input type="text" id="newStudentName" class="form-control" placeholder="Nome do novo aluno">
                    <button class="btn btn-success" onclick="createStudent()" style="margin-top: 10px;">Adicionar Aluno</button>
                </div>
            </div>

            <div id="studentsList"></div>
        </div>
    </div>

    <!-- Modal para Criar/Editar Treino -->
    <div id="workoutModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Criar Novo Treino</h3>
            
            <div class="form-group">
                <label>Aluno</label>
                <select id="modalStudentSelect" class="form-control">
                    <option value="">Selecione um aluno</option>
                </select>
            </div>

            <div class="form-group">
                <label>Dia da Semana</label>
                <div class="day-selector">
                    <div class="day-btn" data-day="segunda">Segunda</div>
                    <div class="day-btn" data-day="terca">Ter√ßa</div>
                    <div class="day-btn" data-day="quarta">Quarta</div>
                    <div class="day-btn" data-day="quinta">Quinta</div>
                    <div class="day-btn" data-day="sexta">Sexta</div>
                    <div class="day-btn" data-day="sabado">S√°bado</div>
                </div>
            </div>

            <div id="exercisesList">
                <h4>Exerc√≠cios</h4>
                <div id="exercisesContainer"></div>
                <button type="button" class="btn btn-secondary" onclick="addExercise()">+ Adicionar Exerc√≠cio</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveWorkout()">Salvar</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwLLJDdIEX7R82RxGTbfAWU3olGBaGfn8",
            authDomain: "p4trainer-268bf.firebaseapp.com",
            projectId: "p4trainer-268bf",
            storageBucket: "p4trainer-268bf.firebasestorage.app",
            messagingSenderId: "249928558281",
            appId: "1:249928558281:web:0de427b8ce07cb0f0d8f18",
            measurementId: "G-CE01C7Z0LB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Estado global
        window.currentUser = null;
        window.currentWorkout = null;
        window.students = [];
        window.workouts = [];

        // Fun√ß√µes de navega√ß√£o
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        window.logout = function() {
            window.currentUser = null;
            showScreen('loginScreen');
            document.getElementById('loginForm').reset();
        }

        window.showAdminScreen = function() {
            showScreen('adminScreen');
            loadWorkouts();
        }

        window.showStudentManagement = function() {
            showScreen('studentSelectionScreen');
            loadStudents();
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'p4trainer') {
                window.currentUser = { type: 'admin', username: 'admin' };
                showAdminScreen();
            } else {
                // Verificar se √© um aluno
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                let found = false;
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    if (student.username === username && student.password === password) {
                        window.currentUser = { type: 'student', id: doc.id, ...student };
                        document.getElementById('studentWelcome').textContent = `üëã Ol√°, ${student.name}!`;
                        showScreen('studentScreen');
                        loadStudentWorkouts();
                        found = true;
                    }
                });
                
                if (!found) {
                    alert('Usu√°rio ou senha incorretos!');
                }
            }
        });

        // Gerenciamento de alunos
        window.loadStudents = async function() {
            const studentsSnapshot = await getDocs(collection(db, 'students'));
            window.students = [];
            studentsSnapshot.forEach(doc => {
                window.students.push({ id: doc.id, ...doc.data() });
            });
            renderStudents();
            updateStudentSelects();
        }

        window.renderStudents = function() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            window.students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div class="student-name">${student.name}</div>
                    <div class="student-workouts">Usu√°rio: ${student.username}</div>
                    <div class="admin-actions">
                        <button class="btn-small btn-danger" onclick="deleteStudent('${student.id}')">Excluir</button>
                    </div>
                `;
                container.appendChild(studentCard);
            });
        }

        window.createStudent = async function() {
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) {
                alert('Digite o nome do aluno!');
                return;
            }

            const username = name.toLowerCase().replace(/\s+/g, '');
            const password = '123456'; // Senha padr√£o

            try {
                await addDoc(collection(db, 'students'), {
                    name: name,
                    username: username,
                    password: password,
                    createdAt: new Date()
                });
                
                document.getElementById('newStudentName').value = '';
                loadStudents();
                alert(`Aluno criado!\nUsu√°rio: ${username}\nSenha: ${password}`);
            } catch (error) {
                alert('Erro ao criar aluno: ' + error.message);
            }
        }

        window.deleteStudent = async function(studentId) {
            if (confirm('Tem certeza que deseja excluir este aluno?')) {
                try {
                    await deleteDoc(doc(db, 'students', studentId));
                    loadStudents();
                } catch (error) {
                    alert('Erro ao excluir aluno: ' + error.message);
                }
            }
        }

        // Gerenciamento de treinos
        window.loadWorkouts = async function() {
            const workoutsSnapshot = await getDocs(collection(db, 'workouts'));
            window.workouts = [];
            workoutsSnapshot.forEach(doc => {
                window.workouts.push({ id: doc.id, ...doc.data() });
            });
            renderWorkouts();
        }

        window.renderWorkouts = function() {
            const container = document.getElementById('workoutsList');
            container.innerHTML = '';
            
            window.workouts.forEach(workout => {
                const student = window.students.find(s => s.id === workout.studentId);
                const studentName = student ? student.name : 'Aluno n√£o encontrado';
                
                const workoutCard = document.createElement('div');
                workoutCard.className = 'workout-card';
                workoutCard.innerHTML = `
                    <div class="workout-day">${capitalizeFirst(workout.day)} - ${studentName}</div>
                    ${workout.exercises.map(exercise => `
                        <div class="exercise-item">
                            ${exercise.image ? `<img src="${exercise.image}" class="exercise-image" alt="${exercise.name}">` : '<div class="exercise-image"></div>'}
                            <div class="exercise-details">
                                <div class="exercise-name">${exercise.name}</div>
                                <div class="exercise-reps">${exercise.sets} s√©ries x ${exercise.reps} repeti√ß√µes</div>
                            </div>
                        </div>
                    `).join('')}
                    <div class="admin-actions">
                        <button class="btn-small btn-secondary" onclick="editWorkout('${workout.id}')">Editar</button>
                        <button class="btn-small btn-danger" onclick="deleteWorkout('${workout.id}')">Excluir</button>
                    </div>
                `;
                container.appendChild(workoutCard);
            });
        }

        window.loadStudentWorkouts = async function() {
            const q = query(collection(db, 'workouts'), where('studentId', '==', window.currentUser.id));
            const workoutsSnapshot = await getDocs(q);
            const studentWorkouts = [];
            workoutsSnapshot.forEach(doc => {
                studentWorkouts.push({ id: doc.id, ...doc.data() });
            });
            renderStudentWorkouts(studentWorkouts);
        }

        window.renderStudentWorkouts = function(workouts) {
            const container = document.getElementById('studentWorkouts');
            container.innerHTML = '';
            
            if (workouts.length === 0) {
                container.innerHTML = '<div class="card"><p>Nenhum treino foi criado para voc√™ ainda.</p></div>';
                return;
            }
            
            workouts.forEach(workout => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'workout-card';
                workoutCard.innerHTML = `
                    <div class="workout-day">${capitalizeFirst(workout.day)}</div>
                    ${workout.exercises.map(exercise => `
                        <div class="exercise-item">
                            ${exercise.image ? `<img src="${exercise.image}" class="exercise-image" alt="${exercise.name}">` : '<div class="exercise-image"></div>'}
                            <div class="exercise-details">
                                <div class="exercise-name">${exercise.name}</div>
                                <div class="exercise-reps">${exercise.sets} s√©ries x ${exercise.reps} repeti√ß√µes</div>
                            </div>
                        </div>
                    `).join('')}
                `;
                container.appendChild(workoutCard);
            });
        }

        // Modal de treino
        window.showCreateWorkout = function() {
            window.currentWorkout = null;
            document.getElementById('modalTitle').textContent = 'Criar Novo Treino';
            resetWorkoutModal();
            document.getElementById('workoutModal').classList.remove('hidden');
        }

        window.editWorkout = function(workoutId) {
            const workout = window.workouts.find(w => w.id === workoutId);
            if (!workout) return;
            
            window.currentWorkout = workout;
            document.getElementById('modalTitle').textContent = 'Editar Treino';
            
            // Preencher formul√°rio
            document.getElementById('modalStudentSelect').value = workout.studentId;
            document.querySelector(`[data-day="${workout.day}"]`).classList.add('active');
            
            // Preencher exerc√≠cios
            const container = document.getElementById('exercisesContainer');
            container.innerHTML = '';
            workout.exercises.forEach(exercise => {
                addExercise(exercise);
            });
            
            document.getElementById('workoutModal').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('workoutModal').classList.add('hidden');
            resetWorkoutModal();
        }

        window.resetWorkoutModal = function() {
            document.getElementById('modalStudentSelect').value = '';
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('exercisesContainer').innerHTML = '';
            addExercise(); // Adicionar um exerc√≠cio vazio
        }

        window.addExercise = function(exerciseData = null) {
            const container = document.getElementById('exercisesContainer');
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-item';
            exerciseDiv.style.flexDirection = 'column';
            exerciseDiv.innerHTML = `
                <div style="display: flex; gap: 10px; width: 100%; align-items: flex-start;">
                    <div style="flex: 1;">
                        <input type="text" placeholder="Nome do exerc√≠cio" class="form-control" value="${exerciseData ? exerciseData.name : ''}" style="margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <input type="number" placeholder="S√©ries" class="form-control" value="${exerciseData ? exerciseData.sets : ''}" min="1">
                            <input type="number" placeholder="Repeti√ß√µes" class="form-control" value="${exerciseData ? exerciseData.reps : ''}" min="1">
                        </div>
                    </div>
                    <button type="button" class="btn-small btn-danger" onclick="removeExercise(this)">Remover</button>
                </div>
                <div style="width: 100%; margin-top: 10px;">
                    <input type="file" accept="image/*" class="form-control" onchange="previewImage(this)">
                    ${exerciseData && exerciseData.image ? `<img src="${exerciseData.image}" class="image-preview" alt="Preview">` : ''}
                </div>
            `;
            container.appendChild(exerciseDiv);
        }

        window.removeExercise = function(button) {
            button.closest('.exercise-item').remove();
        }

        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let preview = input.parentNode.querySelector('.image-preview');
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.className = 'image-preview';
                        input.parentNode.appendChild(preview);
                    }
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Sele√ß√£o de dias
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('day-btn')) {
                document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        window.saveWorkout = async function() {
            const studentId = document.getElementById('modalStudentSelect').value;
            const dayBtn = document.querySelector('.day-btn.active');
            const day = dayBtn ? dayBtn.dataset.day : null;
            
            if (!studentId || !day) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            const exercises = [];
            const exerciseItems = document.querySelectorAll('#exercisesContainer .exercise-item');
            
            for (let item of exerciseItems) {
                const name = item.querySelector('input[placeholder="Nome do exerc√≠cio"]').value.trim();
                const sets = parseInt(item.querySelector('input[placeholder="S√©ries"]').value);
                const reps = parseInt(item.querySelector('input[placeholder="Repeti√ß√µes"]').value);
                const imageFile = item.querySelector('input[type="file"]').files[0];
                
                if (!name || !sets || !reps) {
                    alert('Preencha todos os campos dos exerc√≠cios!');
                    return;
                }
                
                let imageUrl = '';
                if (imageFile) {
                    try {
                        const imageRef = ref(storage, `exercises/${Date.now()}_${imageFile.name}`);
                        await uploadBytes(imageRef, imageFile);
                        imageUrl = await getDownloadURL(imageRef);
                    } catch (error) {
                        console.error('Erro ao fazer upload da imagem:', error);
                    }
                } else if (window.currentWorkout) {
                    // Manter imagem existente se estiver editando
                    const existingExercise = window.currentWorkout.exercises.find(e => e.name === name);
                    imageUrl = existingExercise ? existingExercise.image || '' : '';
                }
                
                exercises.push({ name, sets, reps, image: imageUrl });
            }
            
            const workoutData = {
                studentId,
                day,
                exercises,
                updatedAt: new Date()
            };
            
            try {
                if (window.currentWorkout) {
                    await updateDoc(doc(db, 'workouts', window.currentWorkout.id), workoutData);
                } else {
                    await addDoc(collection(db, 'workouts'), {
                        ...workoutData,
                        createdAt: new Date()
                    });
                }
                
                closeModal();
                loadWorkouts();
                alert('Treino salvo com sucesso!');
            } catch (error) {
                alert('Erro ao salvar treino: ' + error.message);
            }
        }

        window.deleteWorkout = async function(workoutId) {
            if (confirm('Tem certeza que deseja excluir este treino?')) {
                try {
                    await deleteDoc(doc(db, 'workouts', workoutId));
                    loadWorkouts();
                } catch (error) {
                    alert('Erro ao excluir treino: ' + error.message);
                }
            }
        }

        window.updateStudentSelects = function() {
            const select = document.getElementById('modalStudentSelect');
            select.innerHTML = '<option value="">Selecione um aluno</option>';
            window.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        // Utilit√°rios
        window.capitalizeFirst = function(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Inicializa√ß√£o
        window.onload = function() {
            loadStudents();
        }
    </script>
</body>
</html>
